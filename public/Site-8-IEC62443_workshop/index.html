import React, { useState, useRef, useEffect } from 'react';
import { create } from 'zustand';
import { motion, AnimatePresence } from 'framer-motion';
import { ResponsiveBar } from '@nivo/bar';
import { ResponsiveRadar } from '@nivo/radar';
import {
Shield, Activity, Server, Database, Cloud, Cpu,
Lock, AlertTriangle, FileText, Download, Plus,
Minus, Trash2, Box, Square, Circle, Monitor,
CheckCircle2, AlertOctagon, Terminal, FileJson,
Layers, ArrowRight, Save, Layout, GitBranch,
Network, HardDrive, FileCheck, Search, X, Sparkles, Loader2,
ScanEye, BrainCircuit, MessageSquare, Send, Bot
} from 'lucide-react';
import ReactMarkdown from 'react-markdown';

// --- GEMINI API INTEGRATION ---
const apiKey = ""; // API Key injected by environment

const callGemini = async (prompt: string) => {
if (!apiKey) {
console.warn("No API Key provided");
return "AI simulation: API Key missing. Ensure __initial_auth_token is handled if using Firebase, or provide key.";
}

try {
const response = await fetch(
`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
{
method: "POST",
headers: { "Content-Type": "application/json" },
body: JSON.stringify({
contents: [{ parts: [{ text: prompt }] }]
}),
}
);

if (!response.ok) throw new Error(`Gemini API Error: ${response.statusText}`);
const data = await response.json();
return data.candidates?.[0]?.content?.parts?.[0]?.text || "No response from AI.";
} catch (error) {
console.error("AI Call Failed:", error);
return "Error generating AI insight.";
}
};

// --- CONSTANTS ---
const PHASES = [
{ id: 'foundations', label: '1. Foundations', sub: 'Scope & Discovery' },
{ id: 'risk_assess', label: '2. Risk Assessment', sub: 'IRA & DRA' },
{ id: 'design', label: '3. Design', sub: 'SL-T & Compliance' },
{ id: 'implementation', label: '4. Implementation', sub: 'Build & Hardening' },
{ id: 'maintain', label: '5. Maintain', sub: 'Ops & Incident Resp' },
];

const MODULES = [
{ id: 'dashboard', label: 'Project Board', icon: Layout },
{ id: 'hara', label: 'Module 1: IRA/HARA', icon: AlertOctagon },
{ id: 'twin', label: 'Module 2: 3D Twin', icon: Box },
{ id: 'cmdb', label: 'Module 3: CMDB', icon: Database },
{ id: 'compliance', label: 'Module 4: Compliance', icon: FileCheck },
{ id: 'evidence', label: 'Module 5: Evidence', icon: Layers },
];

// --- TYPES ---
interface Asset {
id: string;
name: string;
type: string;
zone: string;
ip?: string;
criticality: 'High' | 'Medium' | 'Low';
aiAnalysis?: string; // Added for AI Enrichment
}

interface RiskScenario {
id: string;
title: string;
assetId: string;
status: 'identified' | 'analyzed' | 'mitigated' | 'accepted';
impact: number;
likelihood: number;
aiSuggestion?: string;
}

interface Artifact {
id: string;
name: string;
type: string;
phase: string;
status: 'draft' | 'approved';
}

interface Requirement {
id: string;
text: string;
source: 'Manual' | 'AI-Generated';
}

// Canvas Types
interface Node {
id: string;
type: string;
x: number;
y: number;
width: number;
height: number;
text: string;
color?: string;
icon?: string;
zIndex: number;
attributes?: { key: string; val: string }[];
}

interface Edge {
id: string;
from: string;
fromSide: string;
to: string;
toSide: string;
style: 'solid' | 'dashed' | 'dotted';
label?: string;
color?: string;
}

interface AppState {
currentPhase: number;
currentModule: string;
setPhase: (idx: number) => void;
setModule: (id: string) => void;
projectStatus: 'foundations' | 'risk_assess' | 'design' | 'implementation' | 'maintain';
assets: Asset[];
risks: RiskScenario[];
artifacts: Artifact[];
requirements: Requirement[];
nodes: Node[];
edges: Edge[];

updateAsset: (id: string, data: Partial<Asset>) => void;
    updateRiskStatus: (id: string, status: RiskScenario['status']) => void;
    updateRiskSuggestion: (id: string, suggestion: string) => void;
    addArtifact: (artifact: Artifact) => void;
    addRequirement: (req: Requirement) => void;

    addNode: (node: Partial<Node>) => void;
        updateNode: (id: string, data: Partial<Node>) => void;
            removeNode: (id: string) => void;
            addEdge: (edge: Edge) => void;
            removeEdge: (id: string) => void;

            advanceProjectPhase: () => void;
            }

            // --- STORE ---
            const useStore = create<AppState>((set, get) => ({
                currentPhase: 0,
                currentModule: 'dashboard',
                projectStatus: 'foundations',

                assets: [
                { id: 'plc-01', name: 'Safety PLC Main', type: 'PLC', zone: 'Zone-Safety', criticality: 'High' },
                { id: 'hmi-01', name: 'Operator HMI', type: 'Workstation', zone: 'Zone-Control', criticality: 'Medium'
                },
                { id: 'gw-01', name: 'Edge Gateway', type: 'Network', zone: 'Zone-DMZ', criticality: 'High' },
                ],

                risks: [
                { id: 'r-1', title: 'PLC Ransomware', assetId: 'plc-01', status: 'identified', impact: 4, likelihood: 3
                },
                { id: 'r-2', title: 'HMI Unauth Access', assetId: 'hmi-01', status: 'analyzed', impact: 3, likelihood: 4
                },
                { id: 'r-3', title: 'Spoofed Sensor Data', assetId: 'gw-01', status: 'mitigated', impact: 5, likelihood:
                2 },
                ],

                artifacts: [
                { id: 'doc-1', name: 'Scope Definition.pdf', type: 'PDF', phase: 'Foundations', status: 'approved' }
                ],

                requirements: [],

                nodes: [
                { id: 'n1', type: 'rect', x: 50, y: 50, width: 220, height: 160, text: "**Zone: Enterprise**\n(Level
                4)", color: '#0f172a', zIndex: 1, icon: 'cloud' },
                { id: 'n2', type: 'rect', x: 350, y: 50, width: 220, height: 160, text: "**Zone: DMZ**\n(Level 3.5)",
                color: '#0f172a', zIndex: 1, icon: 'server' },
                { id: 'n3', type: 'rect', x: 350, y: 300, width: 220, height: 160, text: "**Zone: Control**\n(Level
                2/3)", color: '#172554', zIndex: 1, icon: 'cpu' },
                ],
                edges: [
                { id: 'e1', from: 'n1', fromSide: 'right', to: 'n2', toSide: 'left', style: 'solid', label: 'Ext-Conn'
                },
                { id: 'e2', from: 'n2', fromSide: 'bottom', to: 'n3', toSide: 'top', style: 'dashed', label: 'Mirror' }
                ],

                setPhase: (idx) => set({ currentPhase: idx }),
                setModule: (id) => set({ currentModule: id }),

                updateAsset: (id, data) => set((state) => ({
                assets: state.assets.map(a => a.id === id ? { ...a, ...data } : a)
                })),

                updateRiskStatus: (id, status) => set((state) => ({
                risks: state.risks.map(r => r.id === id ? { ...r, status } : r)
                })),

                updateRiskSuggestion: (id, suggestion) => set((state) => ({
                risks: state.risks.map(r => r.id === id ? { ...r, aiSuggestion: suggestion } : r)
                })),

                addArtifact: (artifact) => set((state) => ({ artifacts: [...state.artifacts, artifact] })),
                addRequirement: (req) => set((state) => ({ requirements: [...state.requirements, req] })),

                addNode: (node) => set((state) => ({
                nodes: [...state.nodes, {
                id: Math.random().toString(36).substr(2, 9),
                type: 'rect', x: 0, y: 0, width: 200, height: 150, text: 'New Asset', zIndex: 1, ...node
                }]
                })),
                updateNode: (id, data) => set((state) => ({
                nodes: state.nodes.map(n => n.id === id ? { ...n, ...data } : n)
                })),
                removeNode: (id) => set((state) => ({
                nodes: state.nodes.filter(n => n.id !== id),
                edges: state.edges.filter(e => e.from !== id && e.to !== id)
                })),
                addEdge: (edge) => set((state) => ({ edges: [...state.edges, edge] })),
                removeEdge: (id) => set((state) => ({ edges: state.edges.filter(e => e.id !== id) })),

                advanceProjectPhase: () => {
                const s = get();
                const phases: AppState['projectStatus'][] = ['foundations', 'risk_assess', 'design', 'implementation',
                'maintain'];
                const idx = phases.indexOf(s.projectStatus);
                if (s.projectStatus === 'risk_assess') {
                const hasIRA = s.artifacts.some(a => a.name.includes('IRA Report'));
                if (!hasIRA) {
                alert("BLOCKING RULE: You cannot move to Design until 'IRA Report' is in the Evidence Locker.");
                return;
                }
                }
                if (idx < phases.length - 1) { set({ projectStatus: phases[idx + 1], currentPhase: idx + 1 }); } } }));
                    // --- GLOBAL AI ASSISTANT --- const GlobalAssistant=()=> {
                    const [isOpen, setIsOpen] = useState(false);
                    const [input, setInput] = useState("");
                    const [messages, setMessages] = useState<{role: 'user' | 'ai' , text: string}[]>([
                        { role: 'ai', text: "Hello. I am CyberRail AI. I have access to your project's Asset Register,
                        Risk Log, and Architecture. How can I assist?" }
                        ]);
                        const [loading, setLoading] = useState(false);
                        const { assets, risks, projectStatus, requirements, nodes, edges } = useStore();
                        const messagesEndRef = useRef<HTMLDivElement>(null);

                            const scrollToBottom = () => {
                            messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
                            };

                            useEffect(() => {
                            scrollToBottom();
                            }, [messages, isOpen]);

                            const handleSend = async () => {
                            if(!input.trim()) return;
                            const userMsg = input;
                            setInput("");
                            setMessages(prev => [...prev, { role: 'user', text: userMsg }]);
                            setLoading(true);

                            const context = `
                            Project Status: ${projectStatus}

                            Assets Summary:
                            - Total Assets: ${assets.length}
                            - High Criticality: ${assets.filter(a => a.criticality === 'High').length}
                            - Asset Types: ${[...new Set(assets.map(a => a.type))].join(', ')}

                            Risk Summary:
                            - Total Scenarios: ${risks.length}
                            - Mitigated: ${risks.filter(r => r.status === 'mitigated').length}
                            - Top Risks: ${risks.filter(r => r.impact >= 4).map(r => r.title).join(', ')}

                            Architecture:
                            - Zones/Nodes: ${nodes.length}
                            - Connections: ${edges.length}

                            User Question: "${userMsg}"

                            Act as an expert IEC 62443 consultant. Answer concisely based on the project data above.
                            `;

                            const response = await callGemini(context);
                            setMessages(prev => [...prev, { role: 'ai', text: response }]);
                            setLoading(false);
                            };

                            return (
                            <>
                                {/* Trigger Button */}
                                <motion.button whileHover={{ scale: 1.05 }} whileTap={{ scale: 0.95 }} onClick={()=>
                                    setIsOpen(!isOpen)}
                                    className={`fixed bottom-6 right-6 z-50 p-4 rounded-full shadow-2xl border
                                    transition-all duration-300
                                    ${isOpen ? 'bg-zinc-800 border-zinc-700 text-zinc-400' : 'bg-gradient-to-br
                                    from-cyan-600 to-purple-600 text-white border-cyan-400 shadow-cyan-500/20'}
                                    `}
                                    >
                                    {isOpen ?
                                    <X size={24} /> :
                                    <Bot size={24} />}
                                </motion.button>

                                {/* Chat Window */}
                                <AnimatePresence>
                                    {isOpen && (
                                    <motion.div initial={{ opacity: 0, y: 50, scale: 0.9 }} animate={{ opacity: 1, y: 0,
                                        scale: 1 }} exit={{ opacity: 0, y: 50, scale: 0.9 }}
                                        className="fixed bottom-24 right-6 w-96 h-[500px] z-50 bg-zinc-950/95 border border-zinc-800 rounded-2xl shadow-2xl flex flex-col overflow-hidden backdrop-blur-xl">
                                        {/* Header */}
                                        <div
                                            className="p-4 border-b border-zinc-800 bg-zinc-900/50 flex items-center gap-3">
                                            <div
                                                className="w-8 h-8 rounded-full bg-gradient-to-br from-cyan-500 to-purple-600 flex items-center justify-center text-white">
                                                <Sparkles size={16} />
                                            </div>
                                            <div>
                                                <h3 className="text-sm font-bold text-white">CyberRail AI</h3>
                                                <p className="text-[10px] text-green-400 flex items-center gap-1">
                                                    <div
                                                        className="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse" />
                                                    Online â€¢ Context Active
                                                </p>
                                            </div>
                                        </div>

                                        {/* Messages */}
                                        <div
                                            className="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar bg-black/20">
                                            {messages.map((m, i) => (
                                            <div key={i} className={`flex ${m.role==='user' ? 'justify-end'
                                                : 'justify-start' }`}>
                                                <div className={`max-w-[80%] rounded-2xl px-4 py-3 text-xs
                                                    leading-relaxed ${m.role==='user'
                                                    ? 'bg-zinc-800 text-white rounded-br-none'
                                                    : 'bg-gradient-to-br from-cyan-950/50 to-purple-950/50 border border-zinc-800 text-zinc-300 rounded-bl-none'
                                                    } `}>
                                                    <ReactMarkdown>{m.text}</ReactMarkdown>
                                                </div>
                                            </div>
                                            ))}
                                            {loading && (
                                            <div className="flex justify-start">
                                                <div
                                                    className="bg-zinc-900/50 rounded-2xl px-4 py-3 rounded-bl-none flex items-center gap-2">
                                                    <Loader2 size={12} className="animate-spin text-cyan-500" />
                                                    <span className="text-xs text-zinc-500">Processing...</span>
                                                </div>
                                            </div>
                                            )}
                                            <div ref={messagesEndRef} />
                                        </div>

                                        {/* Input */}
                                        <div className="p-4 bg-zinc-900/50 border-t border-zinc-800">
                                            <div className="flex gap-2 relative">
                                                <input type="text" value={input} onChange={e=> setInput(e.target.value)}
                                                onKeyDown={e => e.key === 'Enter' && handleSend()}
                                                placeholder="Ask about risks, assets, or requirements..."
                                                className="w-full bg-black border border-zinc-800 rounded-full px-4 py-3
                                                text-xs text-white focus:border-cyan-500 focus:outline-none pr-10"
                                                />
                                                <button onClick={handleSend} disabled={loading || !input.trim()}
                                                    className="absolute right-1 top-1 p-2 bg-zinc-800 rounded-full text-zinc-400 hover:text-white hover:bg-cyan-600 transition-colors disabled:opacity-50">
                                                    <ArrowRight size={14} />
                                                </button>
                                            </div>
                                        </div>
                                    </motion.div>
                                    )}
                                </AnimatePresence>
                            </>
                            );
                            };

                            // --- NAVIGATION COMPONENTS ---
                            const HorizontalNav = () => {
                            const { currentPhase, projectStatus } = useStore();
                            return (
                            <div
                                className="h-16 border-b border-zinc-800 bg-zinc-950 flex items-center px-6 relative z-30">
                                <div className="mr-8 flex items-center gap-2">
                                    <div
                                        className="w-8 h-8 bg-cyan-500 rounded flex items-center justify-center font-bold text-black">
                                        CR</div>
                                    <span className="font-bold text-white tracking-tight">CYBER<span
                                            className="text-cyan-400">RAIL</span></span>
                                </div>
                                <div className="flex-1 flex items-center justify-between relative">
                                    <div className="absolute left-0 top-1/2 w-full h-0.5 bg-zinc-800 -z-10" />
                                    <div className="absolute left-0 top-1/2 h-0.5 bg-cyan-500/50 -z-10 transition-all duration-500"
                                        style={{ width: `${(currentPhase / (PHASES.length - 1)) * 100}%` }} />
                                    {PHASES.map((p, i) => {
                                    const isActive = i === currentPhase;
                                    const isPast = i < currentPhase; return ( <div key={p.id}
                                        className="flex flex-col items-center group cursor-default">
                                        <div className={`w-4 h-4 rounded-full border-2 transition-all duration-300 z-10
                                            ${isActive
                                            ? 'bg-cyan-500 border-cyan-500 scale-125 shadow-[0_0_15px_#22d3ee]' : isPast
                                            ? 'bg-zinc-900 border-cyan-500' : 'bg-zinc-950 border-zinc-700' } `} />
                                        <div className={`mt-2 text-[10px] font-mono uppercase tracking-wider
                                            transition-colors ${isActive ? 'text-cyan-400 font-bold' : 'text-zinc-600' }
                                            `}>
                                            {p.label}
                                        </div>
                                </div>
                                );
                                })}
                            </div>
                            <div className="ml-8 pl-8 border-l border-zinc-800">
                                <div className="text-[10px] text-zinc-500 uppercase font-mono">Current State</div>
                                <div className="text-xs font-bold text-white uppercase">{projectStatus.replace('_', '
                                    ')}</div>
                            </div>
                            </div>
                            );
                            };

                            const VerticalNav = () => {
                            const { currentModule, setModule } = useStore();
                            return (
                            <div
                                className="w-16 bg-zinc-950 border-r border-zinc-800 flex flex-col items-center py-4 gap-4 z-30">
                                {MODULES.map((m) => (
                                <button key={m.id} onClick={()=> setModule(m.id)}
                                    className={`w-10 h-10 rounded-lg flex items-center justify-center transition-all
                                    duration-200 group relative
                                    ${currentModule === m.id ? 'bg-cyan-900/30 text-cyan-400 border border-cyan-500/50
                                    shadow-[0_0_10px_rgba(6,182,212,0.2)]' : 'text-zinc-500 hover:bg-zinc-900
                                    hover:text-zinc-300'}
                                    `}
                                    >
                                    <m.icon size={20} />
                                    <div
                                        className="absolute left-12 bg-zinc-900 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 pointer-events-none whitespace-nowrap border border-zinc-700 z-50">
                                        {m.label}
                                    </div>
                                </button>
                                ))}
                            </div>
                            );
                            };

                            // --- SHARED UI ---
                            const CyberCard = ({ children, className = "", title, icon: Icon, active = false }: any) =>
                            (
                            <motion.div initial={{ opacity: 0, scale: 0.98 }} animate={{ opacity: 1, scale: 1 }}
                                className={`bg-zinc-950/80 border backdrop-blur-md overflow-hidden flex flex-col
                                relative group ${active ? 'border-cyan-500 shadow-[0_0_20px_rgba(6,182,212,0.1)]'
                                : 'border-zinc-800' } ${className} `}>
                                <div className="absolute top-0 left-0 w-2 h-2 border-t border-l border-zinc-500/50" />
                                <div className="absolute top-0 right-0 w-2 h-2 border-t border-r border-zinc-500/50" />
                                <div
                                    className="absolute bottom-0 left-0 w-2 h-2 border-b border-l border-zinc-500/50" />
                                <div
                                    className="absolute bottom-0 right-0 w-2 h-2 border-b border-r border-zinc-500/50" />

                                {(title || Icon) && (
                                <div
                                    className="px-4 py-3 border-b border-zinc-800 flex items-center gap-2 bg-zinc-900/30">
                                    {Icon &&
                                    <Icon size={14} className="text-cyan-400" />}
                                    {title && <h3
                                        className="text-[10px] font-bold text-zinc-400 uppercase tracking-widest font-mono">
                                        {title}</h3>}
                                </div>
                                )}
                                <div
                                    className="p-4 flex-1 overflow-auto custom-scrollbar relative text-zinc-300 text-sm">
                                    {children}
                                </div>
                            </motion.div>
                            );

                            // --- MODULE COMPONENTS ---

                            // MODULE 1: HARA
                            const ModuleHara = () => {
                            const { risks, updateRiskStatus, updateRiskSuggestion, assets } = useStore();
                            const [isAnalyzing, setIsAnalyzing] = useState(false);
                            const columns = ['identified', 'analyzed', 'mitigated', 'accepted'];
                            const onDragStart = (e: React.DragEvent, id: string) => e.dataTransfer.setData("riskId",
                            id);
                            const onDrop = (e: React.DragEvent, status: string) =>
                            updateRiskStatus(e.dataTransfer.getData("riskId"), status as any);

                            const runSafetyAgent = async () => {
                            const identifiedRisks = risks.filter(r => r.status === 'identified');
                            if (identifiedRisks.length === 0) { alert("No risks in 'Identified' column to analyze.");
                            return; }
                            setIsAnalyzing(true);
                            for (const risk of identifiedRisks) {
                            const asset = assets.find(a => a.id === risk.assetId);
                            const prompt = `Act as an IEC 62443 Cybersecurity Expert. Analyze: Risk "${risk.title}" on
                            Asset "${asset?.type || 'Unknown'}". Provide 2 specific, technical mitigation controls (one
                            sentence each).`;
                            const suggestion = await callGemini(prompt);
                            updateRiskSuggestion(risk.id, suggestion);
                            }
                            setIsAnalyzing(false);
                            };

                            return (
                            <div className="h-full flex flex-col p-6">
                                <div className="mb-6 flex justify-between items-end">
                                    <div>
                                        <h2 className="text-2xl font-bold text-white flex items-center gap-2">
                                            <AlertOctagon className="text-cyan-500" /> Risk Board
                                        </h2>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={runSafetyAgent} disabled={isAnalyzing}
                                            className="px-4 py-2 bg-gradient-to-r from-purple-900/50 to-cyan-900/50 text-white border border-cyan-500/50 rounded hover:from-purple-900/70 text-xs font-bold font-mono flex items-center gap-2 shadow-[0_0_15px_rgba(168,85,247,0.3)]">
                                            {isAnalyzing ?
                                            <Loader2 size={14} className="animate-spin" /> :
                                            <Sparkles size={14} />} AI SAFETY AGENT
                                        </button>
                                    </div>
                                </div>
                                <div className="flex-1 grid grid-cols-4 gap-4 overflow-hidden">
                                    {columns.map(col => (
                                    <div key={col} onDragOver={e=> e.preventDefault()} onDrop={e => onDrop(e, col)}
                                        className="flex flex-col bg-zinc-900/30 border border-zinc-800 rounded-lg
                                        overflow-hidden">
                                        <div
                                            className="p-3 bg-zinc-900 border-b border-zinc-800 flex justify-between items-center">
                                            <span
                                                className="text-xs font-bold text-zinc-400 uppercase tracking-wider">{col}</span><span
                                                className="text-[10px] bg-zinc-800 px-2 py-0.5 rounded text-zinc-500">{risks.filter(r
                                                => r.status === col).length}</span></div>
                                        <div className="flex-1 p-2 space-y-2 overflow-y-auto">
                                            {risks.filter(r => r.status === col).map(risk => (
                                            <div key={risk.id} draggable onDragStart={e=> onDragStart(e, risk.id)}
                                                className="p-3 bg-zinc-950 border border-zinc-800 rounded cursor-grab
                                                hover:border-cyan-500/50 hover:shadow-lg transition-all group">
                                                <div className="flex justify-between items-start mb-2"><span
                                                        className="text-xs font-bold text-white group-hover:text-cyan-400">{risk.title}</span>
                                                    <AlertTriangle size={12} className={risk.impact> 3 ? 'text-red-500'
                                                        : 'text-yellow-500'} />
                                                </div>
                                                <div className="text-[10px] text-zinc-500 font-mono mb-2">Asset:
                                                    {risk.assetId}</div>
                                                {risk.aiSuggestion && <div
                                                    className="mb-2 p-2 bg-purple-900/20 border border-purple-500/30 rounded text-[10px] text-purple-200">
                                                    <div
                                                        className="flex items-center gap-1 mb-1 font-bold text-purple-400">
                                                        <Sparkles size={8} /> AI Suggestion:
                                                    </div>
                                                    <div className="line-clamp-3 leading-tight">{risk.aiSuggestion}
                                                    </div>
                                                </div>}
                                                <div className="flex gap-1">{Array.from({length: risk.impact}).map((_,
                                                    i) =>
                                                    <div key={i} className="w-1 h-3 bg-red-500/50 rounded-full" />)}
                                                </div>
                                            </div>
                                            ))}
                                        </div>
                                    </div>
                                    ))}
                                </div>
                            </div>
                            );
                            };

                            // MODULE 3: CMDB
                            const ModuleCMDB = () => {
                            const { assets, updateAsset } = useStore();
                            const [loadingId, setLoadingId] = useState<string | null>(null);

                                const enrichAsset = async (asset: Asset) => {
                                setLoadingId(asset.id);
                                const prompt = `Act as a Cybersecurity Analyst. Generate a brief (2 sentences) risk
                                profile for: Asset: ${asset.name}, Type: ${asset.type}, Zone: ${asset.zone}. Mention
                                typical vulnerabilities (CVE types).`;
                                const analysis = await callGemini(prompt);
                                updateAsset(asset.id, { aiAnalysis: analysis });
                                setLoadingId(null);
                                };

                                return (
                                <div className="h-full p-8 flex flex-col">
                                    <div className="mb-6">
                                        <h2 className="text-2xl font-bold text-white flex items-center gap-2">
                                            <Database className="text-cyan-500" /> Asset Register
                                        </h2>
                                        <p className="text-zinc-500 text-sm font-mono mt-1">Single Source of Truth
                                            (CMDB)</p>
                                    </div>

                                    <div
                                        className="flex-1 bg-zinc-900/30 border border-zinc-800 rounded-lg overflow-hidden">
                                        <table className="w-full text-left text-sm">
                                            <thead className="bg-zinc-900 text-zinc-500 font-mono text-xs uppercase">
                                                <tr>
                                                    <th className="p-4">ID</th>
                                                    <th className="p-4">Name</th>
                                                    <th className="p-4">Type</th>
                                                    <th className="p-4">Zone</th>
                                                    <th className="p-4">Criticality</th>
                                                    <th className="p-4">AI Analysis</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-zinc-800 text-zinc-300">
                                                {assets.map(asset => (
                                                <tr key={asset.id} className="hover:bg-zinc-900/50 transition-colors">
                                                    <td className="p-4 font-mono text-cyan-400">{asset.id}</td>
                                                    <td className="p-4 font-bold">{asset.name}</td>
                                                    <td className="p-4"><span
                                                            className="bg-zinc-800 px-2 py-1 rounded text-xs">{asset.type}</span>
                                                    </td>
                                                    <td className="p-4 text-zinc-400">{asset.zone}</td>
                                                    <td className="p-4">
                                                        <span className={`px-2 py-1 rounded text-[10px] font-bold
                                                            uppercase ${asset.criticality==='High'
                                                            ? 'bg-red-900/30 text-red-400 border border-red-900'
                                                            : 'bg-yellow-900/30 text-yellow-400 border border-yellow-900'
                                                            }`}>{asset.criticality}</span>
                                                    </td>
                                                    <td className="p-4">
                                                        {asset.aiAnalysis ? (
                                                        <div
                                                            className="text-[10px] text-purple-200 bg-purple-900/20 p-2 rounded border border-purple-500/30">
                                                            <div
                                                                className="flex items-center gap-1 mb-1 font-bold text-purple-400">
                                                                <Sparkles size={10} /> Insight
                                                            </div>
                                                            {asset.aiAnalysis}
                                                        </div>
                                                        ) : (
                                                        <button onClick={()=> enrichAsset(asset)}
                                                            disabled={loadingId === asset.id}
                                                            className="text-[10px] flex items-center gap-1
                                                            text-purple-400 hover:text-purple-300 border
                                                            border-purple-900 bg-purple-900/10 px-2 py-1 rounded
                                                            transition-colors"
                                                            >
                                                            {loadingId === asset.id ?
                                                            <Loader2 size={10} className="animate-spin" /> :
                                                            <Sparkles size={10} />}
                                                            Enrich
                                                        </button>
                                                        )}
                                                    </td>
                                                </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                );
                                };

                                // MODULE 4: COMPLIANCE
                                const ModuleCompliance = () => {
                                const { requirements, addRequirement } = useStore();
                                const [zoneType, setZoneType] = useState('Signaling');
                                const [loading, setLoading] = useState(false);

                                const generateRequirements = async () => {
                                setLoading(true);
                                const prompt = `Generate 3 cybersecurity requirements for a Railway "${zoneType}" Zone.
                                Format as JSON array of strings. Do not include markdown.`;
                                try {
                                const text = await callGemini(prompt);
                                const cleaned = text.replace(/```json/g, '').replace(/```/g, '').trim();
                                const reqs = JSON.parse(cleaned);
                                if (Array.isArray(reqs)) {
                                reqs.forEach((r: any) => addRequirement({ id: Math.random().toString().substr(2, 6),
                                text: String(r), source: 'AI-Generated' }));
                                }
                                } catch (e) { alert("Failed to parse AI response."); }
                                setLoading(false);
                                };

                                return (
                                <div className="h-full p-8 flex flex-col">
                                    <div className="mb-6">
                                        <h2 className="text-2xl font-bold text-white flex items-center gap-2">
                                            <FileCheck className="text-cyan-500" /> Compliance Manager
                                        </h2>
                                    </div>
                                    <div className="grid grid-cols-12 gap-6 h-full">
                                        <div
                                            className="col-span-4 bg-zinc-900/50 border border-zinc-800 rounded-xl p-6 h-fit">
                                            <h3 className="text-sm font-bold text-white mb-4 flex items-center gap-2">
                                                <Sparkles size={16} className="text-purple-400" /> AI Generator
                                            </h3>
                                            <select value={zoneType} onChange={(e)=> setZoneType(e.target.value)}
                                                className="w-full bg-black border border-zinc-700 text-white text-xs p-2
                                                rounded mb-4 focus:border-cyan-500 outline-none"><option
                                                    value="Signaling">Signaling</option>
                                                <option value="Passenger Info">Passenger Info</option>
                                            </select>
                                            <button onClick={generateRequirements} disabled={loading}
                                                className="w-full py-2 bg-purple-600 hover:bg-purple-500 text-white text-xs font-bold rounded transition-colors flex justify-center items-center gap-2 shadow-lg">{loading
                                                ?
                                                <Loader2 size={14} className="animate-spin" /> :
                                                <Network size={14} />} Generate
                                            </button>
                                        </div>
                                        <div className="col-span-8 overflow-y-auto pr-2 space-y-3">
                                            {requirements.map(req => (
                                            <motion.div initial={{ opacity: 0, x: 20 }} animate={{ opacity: 1, x: 0 }}
                                                key={req.id}
                                                className="p-4 bg-zinc-950 border border-zinc-800 rounded hover:border-zinc-600 transition-colors group relative">
                                                <div className="flex justify-between items-start mb-2"><span
                                                        className="text-[10px] font-mono text-zinc-500 bg-zinc-900 px-2 py-1 rounded">ID:
                                                        {req.id}</span><span className={`text-[10px] px-2 py-1 rounded
                                                        font-bold ${req.source==='AI-Generated'
                                                        ? 'text-purple-400 bg-purple-900/20'
                                                        : 'text-zinc-400 bg-zinc-800' }`}>{req.source}</span></div>
                                                <p className="text-sm text-zinc-300 leading-relaxed">{req.text}</p>
                                            </motion.div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                                );
                                };

                                // MODULE 2: ARCHITECTURE CANVAS
                                const ArchitectureCanvas = () => {
                                const { nodes, edges, updateNode, addNode, addEdge } = useStore();
                                const [transform, setTransform] = useState({ x: 0, y: 0, k: 1 });
                                const [isPanning, setIsPanning] = useState(false);
                                const [draggingNode, setDraggingNode] = useState<string | null>(null);
                                    const [selection, setSelection] = useState<string | null>(null);
                                        const [aiReview, setAiReview] = useState<string | null>(null);
                                            const [analyzing, setAnalyzing] = useState(false);
                                            const containerRef = useRef<HTMLDivElement>(null);

                                                // AI Architecture Review Logic
                                                const scanArchitecture = async () => {
                                                setAnalyzing(true);
                                                // Simplify graph for LLM
                                                const graphSummary = {
                                                nodes: nodes.map(n => ({ id: n.id, label: n.text, type: n.type })),
                                                connections: edges.map(e => ({ from: e.from, to: e.to, type: e.style }))
                                                };

                                                const prompt = `Act as an IEC 62443 Architect. Review this JSON
                                                topology:
                                                ${JSON.stringify(graphSummary)}

                                                Identify potential security zoning violations or missing boundaries.
                                                Focus on connections between high-trust and low-trust nodes.
                                                Provide a concise list of findings (bullet points).`;

                                                const review = await callGemini(prompt);
                                                setAiReview(review);
                                                setAnalyzing(false);
                                                };

                                                // Canvas Handlers
                                                const handleWheel = (e: React.WheelEvent) => {
                                                const s = -e.deltaY * 0.001;
                                                setTransform(p => ({ ...p, k: Math.max(0.2, p.k + s) }));
                                                };
                                                const handlePointerDown = (e: any) => {
                                                if(e.button===2 || e.altKey) setIsPanning(true);
                                                else setSelection(null);
                                                };
                                                const handlePointerMove = (e: any) => {
                                                if(isPanning) setTransform(p => ({...p, x: p.x+e.movementX, y:
                                                p.y+e.movementY}));
                                                if(draggingNode) {
                                                const n = nodes.find(x => x.id === draggingNode);
                                                if(n) updateNode(draggingNode, {x: n.x + e.movementX/transform.k, y: n.y
                                                + e.movementY/transform.k});
                                                }
                                                };

                                                // Helper for Bezier Curves
                                                const getSideCoordinates = (node: Node, side: string) => {
                                                switch(side) {
                                                case 'top': return { x: node.x + node.width/2, y: node.y };
                                                case 'bottom': return { x: node.x + node.width/2, y: node.y +
                                                node.height };
                                                case 'left': return { x: node.x, y: node.y + node.height/2 };
                                                case 'right': return { x: node.x + node.width, y: node.y + node.height/2
                                                };
                                                }
                                                return { x: node.x, y: node.y };
                                                };

                                                const calculateBezier = (start: any, end: any, startSide: string,
                                                endSide: string) => {
                                                const dist = Math.hypot(end.x - start.x, end.y - start.y);
                                                const curvature = Math.min(dist * 0.5, 150);
                                                let cp1 = { ...start }, cp2 = { ...end };
                                                if (startSide === 'top') cp1.y -= curvature; if (startSide === 'bottom')
                                                cp1.y += curvature; if (startSide === 'left') cp1.x -= curvature; if
                                                (startSide === 'right') cp1.x += curvature;
                                                if (endSide === 'top') cp2.y -= curvature; if (endSide === 'bottom')
                                                cp2.y += curvature; if (endSide === 'left') cp2.x -= curvature; if
                                                (endSide === 'right') cp2.x += curvature;
                                                return `M ${start.x} ${start.y} C ${cp1.x} ${cp1.y}, ${cp2.x} ${cp2.y},
                                                ${end.x} ${end.y}`;
                                                };

                                                return (
                                                <div
                                                    className="flex h-full w-full relative overflow-hidden bg-zinc-950">
                                                    {/* Sidebar Library */}
                                                    <div
                                                        className="w-48 border-r border-zinc-800 bg-black/50 p-4 flex flex-col gap-4 z-10 backdrop-blur-sm">
                                                        <h3
                                                            className="text-xs font-mono uppercase text-zinc-500 font-bold">
                                                            Library</h3>
                                                        {['Zone', 'Workstation', 'PLC', 'Firewall'].map(t => (
                                                        <div key={t} draggable onDragStart={(e)=>
                                                            e.dataTransfer.setData('type', t)} className="p-2
                                                            bg-zinc-900 border border-zinc-800 rounded text-xs
                                                            text-zinc-400 cursor-grab hover:text-white
                                                            hover:border-cyan-500">{t}</div>
                                                        ))}

                                                        <div className="mt-auto border-t border-zinc-800 pt-4">
                                                            <button onClick={scanArchitecture} disabled={analyzing}
                                                                className="w-full py-2 bg-gradient-to-r from-purple-900 to-cyan-900 text-white text-xs font-bold rounded border border-cyan-500/50 hover:shadow-neon flex items-center justify-center gap-2">
                                                                {analyzing ?
                                                                <Loader2 size={12} className="animate-spin" /> :
                                                                <ScanEye size={12} />}
                                                                Scan Architecture
                                                            </button>
                                                        </div>
                                                    </div>

                                                    {/* Canvas Area */}
                                                    <div ref={containerRef}
                                                        className="flex-1 relative cursor-crosshair overflow-hidden"
                                                        onWheel={handleWheel} onPointerDown={handlePointerDown}
                                                        onPointerMove={handlePointerMove} onPointerUp={()=> {
                                                        setIsPanning(false); setDraggingNode(null); }}
                                                        onDragOver={e => e.preventDefault()} onDrop={(e) => {
                                                        const t = e.dataTransfer.getData('type');
                                                        const r = containerRef.current!.getBoundingClientRect();
                                                        addNode({type: 'rect', text: t, x: (e.clientX - r.left -
                                                        transform.x)/transform.k, y: (e.clientY - r.top -
                                                        transform.y)/transform.k, width: 150, height: 100});
                                                        }}
                                                        style={{ backgroundImage: 'radial-gradient(#27272a 1px,
                                                        transparent 1px)', backgroundSize: `${20 * transform.k}px ${20 *
                                                        transform.k}px`, backgroundPosition: `${transform.x}px
                                                        ${transform.y}px` }}>

                                                        <div style={{ transform: `translate(${transform.x}px,
                                                            ${transform.y}px) scale(${transform.k})`,
                                                            transformOrigin: '0 0' , width: '100%' , height: '100%' ,
                                                            position: 'absolute' }}>
                                                            <svg
                                                                className="absolute w-full h-full pointer-events-none overflow-visible">
                                                                {edges.map(e => {
                                                                const n1 = nodes.find(n => n.id === e.from); const n2 =
                                                                nodes.find(n => n.id === e.to);
                                                                if(!n1 || !n2) return null;
                                                                const start = getSideCoordinates(n1, e.fromSide); const
                                                                end = getSideCoordinates(n2, e.toSide);
                                                                const path = calculateBezier(start, end, e.fromSide,
                                                                e.toSide);
                                                                return
                                                                <path key={e.id} d={path} stroke="#52525b"
                                                                    strokeWidth="2" strokeDasharray={e.style==='dashed'
                                                                    ? '5,5' : '' } fill="none" />
                                                                })}
                                                            </svg>
                                                            {nodes.map(n => (
                                                            <div key={n.id} onPointerDown={(e)=> { e.stopPropagation();
                                                                setSelection(n.id); setDraggingNode(n.id); }}
                                                                className={`absolute border bg-zinc-900 p-2 flex
                                                                flex-col shadow-lg ${selection === n.id ?
                                                                'border-cyan-500' : 'border-zinc-700'}`}
                                                                style={{ transform: `translate(${n.x}px, ${n.y}px)`,
                                                                width: n.width, height: n.height }}>
                                                                <div
                                                                    className="text-[10px] font-mono text-cyan-500 mb-1">
                                                                    {n.type}</div>
                                                                <div
                                                                    className="text-xs text-zinc-300 font-mono whitespace-pre-wrap">
                                                                    {n.text.replace(/\*\*/g, '')}</div>
                                                            </div>
                                                            ))}
                                                        </div>

                                                        {/* AI Results Overlay */}
                                                        <AnimatePresence>
                                                            {aiReview && (
                                                            <motion.div initial={{ x: 300, opacity: 0 }} animate={{ x:
                                                                0, opacity: 1 }} exit={{ x: 300, opacity: 0 }}
                                                                className="absolute top-4 right-4 w-80 bg-zinc-950/95 border border-purple-500/50 p-4 rounded-lg shadow-2xl backdrop-blur-md">
                                                                <div
                                                                    className="flex justify-between items-center mb-3 border-b border-purple-900 pb-2">
                                                                    <h3
                                                                        className="text-sm font-bold text-white flex items-center gap-2">
                                                                        <BrainCircuit size={16}
                                                                            className="text-purple-400" /> Security
                                                                        Findings
                                                                    </h3>
                                                                    <button onClick={()=> setAiReview(null)}>
                                                                        <X size={14}
                                                                            className="text-zinc-500 hover:text-white" />
                                                                    </button>
                                                                </div>
                                                                <div
                                                                    className="text-xs text-zinc-300 font-mono leading-relaxed whitespace-pre-wrap max-h-96 overflow-y-auto custom-scrollbar">
                                                                    {aiReview}
                                                                </div>
                                                            </motion.div>
                                                            )}
                                                        </AnimatePresence>
                                                    </div>
                                                </div>
                                                );
                                                };

                                                // MODULE 5: EVIDENCE LOCKER
                                                const ModuleEvidence = () => {
                                                const { artifacts, addArtifact } = useStore();
                                                const handleDrop = (e: React.DragEvent) => { e.preventDefault();
                                                addArtifact({ id: Math.random().toString(), name: "Imported_Doc.pdf",
                                                type: 'PDF', phase: 'Unknown', status: 'draft' }); };
                                                return (
                                                <div className="h-full p-8 flex flex-col" onDragOver={e=>
                                                    e.preventDefault()} onDrop={handleDrop}>
                                                    <div className="mb-6 flex justify-between items-end">
                                                        <div>
                                                            <h2
                                                                className="text-2xl font-bold text-white flex items-center gap-2">
                                                                <Layers className="text-cyan-500" /> Evidence Locker
                                                            </h2>
                                                        </div>
                                                        <div
                                                            className="p-4 border border-dashed border-zinc-700 rounded-lg text-zinc-500 text-xs font-mono">
                                                            DRAG FILES HERE TO UPLOAD</div>
                                                    </div>
                                                    <div className="grid grid-cols-4 gap-4">
                                                        {artifacts.map(file => (
                                                        <div key={file.id}
                                                            className="p-4 bg-zinc-900 border border-zinc-800 rounded hover:border-cyan-500 transition-colors group">
                                                            <FileText size={24}
                                                                className="text-zinc-600 group-hover:text-cyan-400 mb-3" />
                                                            <div className="font-bold text-sm text-white truncate">
                                                                {file.name}</div>
                                                            <div className="flex justify-between items-center mt-2">
                                                                <span
                                                                    className="text-[10px] text-zinc-500 uppercase">{file.type}</span><span
                                                                    className={`text-[10px] px-1.5 py-0.5 rounded
                                                                    ${file.status==='approved'
                                                                    ? 'bg-green-900/30 text-green-400'
                                                                    : 'bg-yellow-900/30 text-yellow-400'
                                                                    }`}>{file.status}</span></div>
                                                        </div>
                                                        ))}
                                                    </div>
                                                </div>
                                                );
                                                };

                                                // --- LEVEL 1 KANBAN: PROJECT BOARD (DASHBOARD) ---
                                                const ProjectBoard = () => {
                                                const { projectStatus, artifacts, advanceProjectPhase, addArtifact } =
                                                useStore();
                                                const columns = [
                                                { id: 'foundations', title: 'Foundations' }, { id: 'risk_assess', title:
                                                'Risk Assess' }, { id: 'design', title: 'Design' }, { id:
                                                'implementation', title: 'Implement' }, { id: 'maintain', title:
                                                'Maintain' }
                                                ];
                                                const generateReport = () => { addArtifact({ id: 'rep-1', name: 'IRA
                                                Report Final.pdf', type: 'PDF', phase: 'Risk Assess', status: 'approved'
                                                }); };

                                                return (
                                                <div className="h-full p-8 flex flex-col bg-zinc-950">
                                                    <div className="mb-8">
                                                        <h2 className="text-3xl font-bold text-white mb-2">Project Board
                                                            <span className="text-zinc-600 text-lg">// Level 1
                                                                Kanban</span></h2>
                                                        <p className="text-zinc-500">Track the System Under
                                                            Consideration (SuC) through the IEC 62443 lifecycle.</p>
                                                    </div>
                                                    <div className="flex-1 flex gap-4 overflow-x-auto pb-4">
                                                        {columns.map((col) => {
                                                        const isCurrent = projectStatus === col.id;
                                                        const isPast = PHASES.findIndex(p => p.id === col.id) <
                                                            PHASES.findIndex(p=> p.id === projectStatus);
                                                            return (
                                                            <div key={col.id} className={`flex-1 min-w-[200px] flex
                                                                flex-col rounded-lg border ${isCurrent
                                                                ? 'bg-zinc-900/50 border-cyan-500/50'
                                                                : 'bg-zinc-900/20 border-zinc-800' }`}>
                                                                <div className={`p-3 border-b text-sm font-bold
                                                                    uppercase tracking-wider ${isCurrent
                                                                    ? 'bg-cyan-900/20 text-cyan-400 border-cyan-900'
                                                                    : 'bg-zinc-900 text-zinc-500 border-zinc-800' }`}>
                                                                    {col.title}</div>
                                                                <div className="flex-1 p-3 relative">
                                                                    {isCurrent && (
                                                                    <motion.div layoutId="project-card"
                                                                        className="p-4 bg-zinc-800 border border-zinc-700 rounded shadow-xl">
                                                                        <div className="flex items-center gap-2 mb-3">
                                                                            <div
                                                                                className="w-2 h-2 bg-green-500 rounded-full animate-pulse" />
                                                                            <span
                                                                                className="text-xs font-bold text-white">Project:
                                                                                Metro_Sig</span>
                                                                        </div>
                                                                        <div
                                                                            className="text-[10px] text-zinc-400 font-mono mb-4">
                                                                            {col.id === 'risk_assess' ? 'Blocking:
                                                                            Awaiting IRA Report' : 'Status: In
                                                                            Progress'}</div>
                                                                        <button onClick={advanceProjectPhase}
                                                                            className="w-full py-2 bg-cyan-600 text-white text-xs font-bold rounded hover:bg-cyan-500 transition-colors flex justify-center items-center gap-2">Next
                                                                            Phase
                                                                            <ArrowRight size={12} />
                                                                        </button>
                                                                        {col.id === 'risk_assess' && !artifacts.some(a
                                                                        => a.name.includes('IRA')) && (
                                                                        <button onClick={generateReport}
                                                                            className="mt-2 w-full py-1 border border-zinc-600 text-zinc-400 text-[10px] rounded hover:text-white hover:border-white">[Dev]
                                                                            Generate IRA Report</button>
                                                                        )}
                                                                    </motion.div>
                                                                    )}
                                                                    {isPast && (
                                                                    <div
                                                                        className="p-4 border border-dashed border-zinc-800 rounded opacity-50">
                                                                        <div className="flex items-center gap-2">
                                                                            <CheckCircle2 size={14}
                                                                                className="text-green-500" /><span
                                                                                className="text-xs text-zinc-500 decoration-line-through">Metro_Sig</span>
                                                                        </div>
                                                                    </div>
                                                                    )}
                                                                </div>
                                                            </div>
                                                            );
                                                            })}
                                                    </div>
                                                </div>
                                                );
                                                };

                                                // HANDOVER MODULE WITH AI
                                                const ViewHandover = () => {
                                                const [summary, setSummary] = useState<string | null>(null);
                                                    const [generating, setGenerating] = useState(false);
                                                    const { assets, risks, requirements } = useStore();

                                                    const generateHandover = async () => {
                                                    setGenerating(true);
                                                    const prompt = `Generate a formal Handover Executive Summary for the
                                                    Cybersecurity Case.
                                                    Project Data:
                                                    - ${assets.length} Assets Identified
                                                    - ${risks.filter(r => r.status === 'mitigated').length} Risks
                                                    Mitigated
                                                    - ${requirements.length} Requirements Implemented

                                                    Structure:
                                                    1. Introduction
                                                    2. Residual Risk Statement
                                                    3. Operational constraints

                                                    Keep it concise and professional.`;

                                                    const result = await callGemini(prompt);
                                                    setSummary(result);
                                                    setGenerating(false);
                                                    };

                                                    return (
                                                    <div
                                                        className="h-full p-8 flex flex-col items-center justify-center">
                                                        <CyberCard
                                                            className="max-w-xl w-full text-center p-10 border-t-4 border-t-cyan-500 relative">
                                                            <div
                                                                className="mx-auto w-20 h-20 bg-zinc-900 rounded-full flex items-center justify-center mb-6 text-cyan-500 shadow-[0_0_30px_rgba(6,182,212,0.2)]">
                                                                <Shield size={40} />
                                                            </div>
                                                            <h2 className="text-2xl font-bold text-white mb-2">System
                                                                Acceptance</h2>
                                                            <p className="text-zinc-400 text-sm mb-8">NP-8: Transfer of
                                                                Cybersecurity Case & Residual Risk to Operations.</p>

                                                            <div className="grid grid-cols-2 gap-4 text-left mb-8">
                                                                <div
                                                                    className="p-3 bg-zinc-900 border border-zinc-800 rounded">
                                                                    <span
                                                                        className="block text-[10px] text-zinc-500 uppercase">Cybersecurity
                                                                        Case</span><span
                                                                        className="text-sm font-mono text-white">READY_FOR_SIGN</span>
                                                                </div>
                                                                <div
                                                                    className="p-3 bg-zinc-900 border border-zinc-800 rounded">
                                                                    <span
                                                                        className="block text-[10px] text-zinc-500 uppercase">Safety
                                                                        Case Ref</span><span
                                                                        className="text-sm font-mono text-white">SC_V4.1_LINKED</span>
                                                                </div>
                                                            </div>

                                                            {!summary ? (
                                                            <button onClick={generateHandover} disabled={generating}
                                                                className="bg-cyan-600 text-white px-8 py-3 rounded font-bold hover:bg-cyan-500 transition-colors shadow-lg flex items-center gap-2 mx-auto">
                                                                {generating ?
                                                                <Loader2 className="animate-spin" size={16} /> :
                                                                <Sparkles size={16} />}
                                                                Generate Handover Executive Summary
                                                            </button>
                                                            ) : (
                                                            <div
                                                                className="mt-4 text-left p-4 bg-zinc-900/50 rounded border border-zinc-800 max-h-60 overflow-y-auto custom-scrollbar">
                                                                <h3
                                                                    className="text-xs font-bold text-cyan-400 mb-2 uppercase">
                                                                    AI Generated Draft</h3>
                                                                <div
                                                                    className="text-xs text-zinc-300 font-mono leading-relaxed whitespace-pre-wrap">
                                                                    <ReactMarkdown>{summary}</ReactMarkdown>
                                                                </div>
                                                                <button onClick={()=> setSummary(null)} className="mt-4
                                                                    text-xs text-zinc-500 hover:text-white
                                                                    underline">Clear & Regenerate</button>
                                                            </div>
                                                            )}
                                                        </CyberCard>
                                                    </div>
                                                    );
                                                    };

                                                    // --- MAIN LAYOUT ---
                                                    const App = () => {
                                                    const { currentModule } = useStore();
                                                    const renderModule = () => {
                                                    switch(currentModule) {
                                                    case 'dashboard': return
                                                    <ProjectBoard />;
                                                    case 'hara': return
                                                    <ModuleHara />;
                                                    case 'twin': return
                                                    <ArchitectureCanvas />;
                                                    case 'cmdb': return
                                                    <ModuleCMDB />;
                                                    case 'compliance': return
                                                    <ModuleCompliance />;
                                                    case 'evidence': return
                                                    <ModuleEvidence />;
                                                    // Mapping for phase views if module selection logic differs, but
                                                    here standardizing:
                                                    default: return
                                                    <ProjectBoard />;
                                                    }
                                                    };

                                                    // Override render for phases if accessed via top nav logic
                                                    (simplified here to module-based for clarity)
                                                    // To fully support the specific Phase views (Concept, Definition
                                                    etc) alongside modules, we'd need a router or complex state
                                                    // For this demo, we assume Modules are the primary workspace, but
                                                    let's wire the Handover view specifically since we added AI there.
                                                    // Actually, let's just make the "Handover" phase link to a module
                                                    view or a specific view.
                                                    // For simplicity in this file, I'll map the "Handover" concept to a
                                                    specific view if requested, but standard usage relies on modules.
                                                    // Let's add a hack: if currentPhase is 4 (Handover), show Handover
                                                    view? No, that breaks the "Workbench" concept.
                                                    // I will add "Handover" to the module list temporarily to show it
                                                    off, or just replace dashboard?
                                                    // Better: I will make the "Maintain" phase click render the
                                                    Handover view for this demo.

                                                    const { currentPhase } = useStore();
                                                    const activeView = currentPhase === 4 && currentModule ===
                                                    'dashboard' ?
                                                    <ViewHandover /> : renderModule();

                                                    return (
                                                    <div
                                                        className="flex flex-col h-screen bg-black text-zinc-100 font-sans overflow-hidden">
                                                        <HorizontalNav />
                                                        <div className="flex flex-1 overflow-hidden">
                                                            <VerticalNav />
                                                            <main className="flex-1 bg-black relative overflow-hidden">
                                                                <div className="absolute inset-0 opacity-20 pointer-events-none"
                                                                    style={{
                                                                    backgroundImage: 'radial-gradient(#3f3f46 1px, transparent 1px)'
                                                                    , backgroundSize: '40px 40px' }} />
                                                                <div className="relative z-10 h-full">
                                                                    <AnimatePresence mode="wait">
                                                                        <motion.div key={currentModule + currentPhase}
                                                                            initial={{ opacity: 0, x: 20 }} animate={{
                                                                            opacity: 1, x: 0 }} exit={{ opacity: 0, x:
                                                                            -20 }} transition={{ duration: 0.2 }}
                                                                            className="h-full w-full">
                                                                            {activeView}
                                                                        </motion.div>
                                                                    </AnimatePresence>
                                                                </div>
                                                            </main>
                                                        </div>
                                                        <GlobalAssistant />
                                                    </div>
                                                    );
                                                    };

                                                    export default App;